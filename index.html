<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<title>SHM Web Simulator ‚Äî Final Ultimate</title>
<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:18px;background:#f7f9fb;color:#111}
  h1{margin-bottom:6px}
  .box{background:white;padding:12px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.08);margin-bottom:14px}
  textarea{width:100%;height:200px;font-family:monospace}
  button{padding:8px 12px;margin:6px;background:#1677ff;color:white;border:none;border-radius:6px;cursor:pointer}
  .warning{color:#b91c1c;font-weight:700}
  table{width:100%;border-collapse:collapse}
  td,th{border:1px solid #e6eef6;padding:6px}
</style>
</head>
<body>
  <h1>SHM Web Simulator ‚Äî Final Ultimate</h1>

  <div class="box">
    <h3>üìò ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏™‡∏£‡∏∏‡∏õ)</h3>
    <p>‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏±‡πâ‡∏ô ‡πÜ: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <b>system</b> ‡πÄ‡∏õ‡πá‡∏ô <code>spring</code> ‡∏´‡∏£‡∏∑‡∏≠ <code>pendulum</code> ‚Üí ‡πÉ‡∏™‡πà <b>states</b> ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ JSON (1‚Äì4 ‡∏™‡∏†‡∏≤‡∏ß‡∏∞) ‚Üí ‡∏Ñ‡πà‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏´‡∏£‡∏∑‡∏≠ <code>"="</code> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏™‡∏†‡∏≤‡∏ß‡∏∞‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å backfilled)</p>
    <p>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö: <code>m,k,L,g,sigmaF,x,v,Vmax,a_max,a,KE,PE,E,A,omega,f,T</code></p>
    <details>
      <summary>üîç ‡∏™‡∏π‡∏ï‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢)</summary>
      <pre>
‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô:
  œâ = 2œÄ f = 2œÄ / T
  f = 1 / T
  a = -œâ¬≤ x

‡∏™‡∏õ‡∏£‡∏¥‡∏á:
  œâ = ‚àö(k/m)
  T = 2œÄ ‚àö(m/k)
  Œ£F (equilibrium) = k x = m g

‡∏•‡∏π‡∏Å‡∏ï‡∏∏‡πâ‡∏° (small-angle):
  œâ = ‚àö(g/L)
  T = 2œÄ ‚àö(L/g)

‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤:
  x(t) = A cos(œâ t + œÜ)  ‡∏´‡∏£‡∏∑‡∏≠ x(t) = A sin(œâ t + œÜ)

‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß/‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á:
  v = ¬± œâ ‚àö(A¬≤ - x¬≤)
  a = -œâ¬≤ x
  Vmax = œâ A
  a_max = œâ¬≤ A

‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô:
  KE = ¬Ω m v¬≤ = ¬Ω m œâ¬≤ (A¬≤ - x¬≤)
  PE = ¬Ω k x¬≤ = ¬Ω m œâ¬≤ x¬≤
  E_total = ¬Ω k A¬≤ = ¬Ω m œâ¬≤ A¬≤
      </pre>
    </details>
  </div>

  <div class="box">
    <h3>üîß ‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢ (Wizard) ‚Äî ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå</h3>
    <button onclick="loadExample('spring1')">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏™‡∏õ‡∏£‡∏¥‡∏á (m=2kg ‚Üí m=0.5kg)</button>
    <button onclick="loadExample('spring2')">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏™‡∏õ‡∏£‡∏¥‡∏á (m=0.05kg ‡∏¢‡∏∑‡∏î 2cm + ‡∏î‡∏∂‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°)</button>
    <button onclick="loadExample('pendulum1')">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏•‡∏π‡∏Å‡∏ï‡∏∏‡πâ‡∏° (L=2 ‚Üí L=8)</button>
    <button onclick="clearAll()">‡∏•‡πâ‡∏≤‡∏á</button>
  </div>

  <div class="box">
    <h3>üìù ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (JSON)</h3>
    <p>‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:</p>
    <pre>{
  "system":"spring",
  "states":[
    {"m":2,"x":0.1,"g":9.81},
    {"m":0.5,"x":"=","g":"="}
  ]
}</pre>
    <textarea id="inputJson">{"system":"spring","states":[{"m":2,"x":0.1,"g":9.81},{"m":0.5,"x":"=","g":"="}]}</textarea>
    <br>
    <button onclick="send()">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
  </div>

  <div id="result" class="box"></div>

  <div id="plots" class="box"></div>

<script>
function loadExample(name){
  let obj;
  if(name==='spring1'){
    obj = {"system":"spring","states":[{"m":2,"x":0.1,"g":9.81},{"m":0.5,"x":"=","g":"="}]};
  } else if(name==='spring2'){
    obj = {"system":"spring","states":[{"m":0.05,"x":0.02,"g":9.81},{"m":"=","A":0.025,"x":0}]};
  } else {
    obj = {"system":"pendulum","states":[{"L":2,"T":2.5},{"L":8,"T":""}]};
  }
  document.getElementById('inputJson').value = JSON.stringify(obj,null,2);
  send();
}

function clearAll(){
  document.getElementById('inputJson').value = '';
  document.getElementById('result').innerHTML = '';
  document.getElementById('plots').innerHTML = '';
}

async function send(){
  try{
    const payload = JSON.parse(document.getElementById('inputJson').value);
    const res = await fetch('/solve',{method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify(payload)});
    const data = await res.json();
    renderResult(data);
  } catch(err){
    document.getElementById('result').innerHTML = '<div class="warning">Error: '+err+'</div>';
  }
}

function renderResult(data){
  const results = data.results;
  let html = '';
  results.forEach((s,i)=>{
    html += `<h3>‡∏™‡∏†‡∏≤‡∏ß‡∏∞ ${i+1}</h3>`;
    html += '<table>';
    html += '<tr><th>‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£</th><th>‡∏Ñ‡πà‡∏≤</th></tr>';
    for(const k of ["m","k","L","g","sigmaF","x","A","omega","f","T","v","Vmax","a","a_max","KE","PE","E"]){
      const v = s[k];
      html += `<tr><td>${k}</td><td>${v===null?'-':v}</td></tr>`;
    }
    html += '</table>';
    if(s.warnings && s.warnings.length){
      html += `<div class="warning"><b>‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</b><br>${s.warnings.join('<br>')}</div>`;
    }
    html += `<pre>${s.explanation}</pre>`;
  });

  document.getElementById('result').innerHTML = html;

  // build plots for first state that has omega & A
  document.getElementById('plots').innerHTML = '';
  for(const s of results){
    if(s.omega && s.A){
      buildPlots(s);
      break;
    }
  }
}

function buildPlots(s){
  const omega = s.omega;
  const A = s.A;
  if(!omega || !A) return;
  const N = 400;
  const dt = (2*Math.PI/omega) / 100; // sample ~100 pts per period
  const t = [];
  const x = [], v = [], a = [];
  for(let i=0;i<N;i++){
    const tt = i*dt;
    t.push(tt);
    x.push(A*Math.cos(omega*tt));
    v.push(-A*omega*Math.sin(omega*tt));
    a.push(-A*omega*omega*Math.cos(omega*tt));
  }

  // Plotly
  const plotDiv = document.createElement('div');
  plotDiv.style.marginTop = '12px';
  plotDiv.style.height = '360px';
  plotDiv.id = 'plot_'+Math.random().toString(36).slice(2,9);
  document.getElementById('plots').appendChild(plotDiv);

  const traces = [
    {x:t, y:x, name:'x(t)', mode:'lines'},
    {x:t, y:v, name:'v(t)', mode:'lines', yaxis:'y2'},
    {x:t, y:a, name:'a(t)', mode:'lines', yaxis:'y3'}
  ];
  const layout = {
    title: 'x(t), v(t), a(t)',
    xaxis:{title:'t (s)'},
    yaxis:{title:'x (m)'},
    yaxis2:{title:'v (m/s)',overlaying:'y',side:'right'},
    yaxis3:{title:'a (m/s¬≤)',anchor:'free',overlaying:'y',side:'left',position:0.02}
  };
  Plotly.newPlot(plotDiv, traces, layout, {responsive:true});
}
</script>
</body>
</html>
